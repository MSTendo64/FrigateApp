<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:FrigateApp.ViewModels"
             xmlns:conv="using:Avalonia.Data.Converters"
             xmlns:controls="using:FrigateApp.Controls"
             xmlns:media="using:Avalonia.Media"
             xmlns:localconv="using:FrigateApp.Converters"
             x:Class="FrigateApp.Views.CamerasView"
             x:DataType="vm:CamerasViewModel"
             x:CompileBindings="True">

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Верхняя панель (уменьшенная) -->
        <Border Grid.Row="0" Background="#1a1a1a" Padding="8,2" BorderBrush="#333" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto">
                <!-- Кнопка toggle sidebar -->
                <Button Grid.Column="0" Content="☰" Width="28" Height="24" 
                        Padding="0" Margin="0,0,6,0"
                        FontSize="15"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        Command="{Binding ToggleSidebarCommand}"
                        ToolTip.Tip="Показать/скрыть группы"/>
                
                <TextBlock Grid.Column="1" Text="{Binding Title}" FontSize="13" FontWeight="SemiBold" VerticalAlignment="Center"/>
                
                <!-- Ползунок размера сетки -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="5" Margin="0,0,10,0" VerticalAlignment="Center">
                    <TextBlock Text="Размер:" FontSize="10" VerticalAlignment="Center" Foreground="#888"/>
                    <Slider Value="{Binding TileScale}" 
                            Minimum="0.5" 
                            Maximum="2.0" 
                            Width="90"
                            VerticalAlignment="Center"
                            TickFrequency="0.1"
                            IsSnapToTickEnabled="True"/>
                    <TextBlock Text="{Binding TileScale, StringFormat='{}{0:F1}x'}" 
                               FontSize="10" 
                               VerticalAlignment="Center" 
                               Width="30"
                               Foreground="#888"/>
                </StackPanel>
                
                <Button Grid.Column="3" Content="Настройки"
                        Command="{Binding OpenSettingsCommand}"
                        Height="24"
                        Padding="6,0"
                        FontSize="10"
                        VerticalContentAlignment="Center"
                        Margin="0,0,5,0"
                        ToolTip.Tip="Настройки приложения"/>
                <Button Grid.Column="4" Content="Выйти"
                        Command="{Binding LogoutCommand}"
                        Height="24"
                        Padding="6,0"
                        FontSize="10"
                        VerticalContentAlignment="Center"/>
            </Grid>
        </Border>

        <Grid Grid.Row="1" ColumnDefinitions="Auto,*">
            <!-- Боковая панель -->
            <Border Grid.Column="0" Background="#1a1a1a" BorderBrush="#333" BorderThickness="0,0,1,0"
                    Padding="8,12"
                    IsVisible="{Binding IsSidebarVisible}">
                <StackPanel Spacing="4">
                    <TextBlock Text="Камеры" FontSize="12" Foreground="#888" Margin="0,0,0,8"/>
                    <ItemsControl ItemsSource="{Binding SidebarItems}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="vm:SidebarItemViewModel">
                                <Button Content="{Binding DisplayName}"
                                        Command="{Binding SelectCommand}"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Left"
                                        Padding="10,8"
                                        Margin="0,0,0,2"
                                        BorderThickness="0"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <TextBlock Text="Раздел" FontSize="12" Foreground="#888" Margin="0,16,0,8"/>
                    <Button Content="Обзор событий"
                            Command="{Binding OpenEventsCommand}"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Padding="10,8"
                            Margin="0,0,0,2"
                            BorderThickness="0"
                            ToolTip.Tip="Список событий с фильтрами"/>
                    <Button Content="Записи"
                            Command="{Binding OpenRecordingsCommand}"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Padding="10,8"
                            Margin="0,0,0,2"
                            BorderThickness="0"
                            ToolTip.Tip="Просмотр записей по камерам и времени"/>
                </StackPanel>
            </Border>

            <!-- Контент: сетка камер + кнопка сброса зумов -->
            <Grid Grid.Column="1">
                <ScrollViewer Name="CameraScrollViewer" 
                              Background="#0d0d0d" 
                              HorizontalScrollBarVisibility="Disabled" 
                              VerticalScrollBarVisibility="Auto"
                              ScrollChanged="OnScrollChanged">
                    <StackPanel Margin="12">
                    <ProgressBar IsIndeterminate="True" IsVisible="{Binding IsLoading}" Height="2" Margin="0,0,0,8"/>

                    <TextBlock Text="{Binding LoadError}"
                               Foreground="Orange"
                               IsVisible="{Binding LoadError, Converter={x:Static conv:StringConverters.IsNotNullOrEmpty}}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,8"/>

                    <ItemsControl ItemsSource="{Binding Cameras}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <controls:CameraGridPanel TileScale="{Binding $parent[UserControl].((vm:CamerasViewModel)DataContext).TileScale}"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="vm:CameraItemViewModel">
                                <Button Background="Transparent" Padding="0" Command="{Binding OpenPlayerCommand}"
                                        Cursor="Hand" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch"
                                        BorderThickness="0" Focusable="False"
                                        MinWidth="{Binding TileWidth}" Width="{Binding TileWidth}"
                                        MinHeight="{Binding TileHeight}" Height="{Binding TileHeight}">
                                    <Grid ClipToBounds="True" PointerWheelChanged="OnCameraTilePointerWheel">
                                        <Panel RenderTransformOrigin="0,0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                                            <Panel.RenderTransform>
                                                <TransformGroup>
                                                    <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}"/>
                                                    <TranslateTransform X="{Binding PanX}" Y="{Binding PanY}"/>
                                                </TransformGroup>
                                            </Panel.RenderTransform>
                                            <controls:CameraTileContent HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                        </Panel>
                                        <TextBlock Text="{Binding ErrorText}"
                                                   IsVisible="{Binding HasError}"
                                                   Foreground="Orange" FontSize="11"
                                                   HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <TextBlock.Effect>
                                                <media:DropShadowEffect Color="Black" BlurRadius="2" OffsetX="0" OffsetY="0" Opacity="1"/>
                                            </TextBlock.Effect>
                                        </TextBlock>
                                        <TextBlock Text="{Binding DisplayName}" FontSize="10" Foreground="White"
                                                   VerticalAlignment="Top" HorizontalAlignment="Right"
                                                   Margin="0,4,6,0">
                                            <TextBlock.Effect>
                                                <media:DropShadowEffect Color="Black" BlurRadius="2" OffsetX="0" OffsetY="0" Opacity="1"/>
                                            </TextBlock.Effect>
                                        </TextBlock>
                                        <TextBlock Text="{Binding StatsText}" FontSize="9" Foreground="#aaa"
                                                   VerticalAlignment="Bottom" HorizontalAlignment="Left"
                                                   Margin="4" Background="#CC000000" Padding="4,2"
                                                   IsVisible="{Binding $parent[UserControl].((vm:CamerasViewModel)DataContext).IsStatsVisible}">
                                            <TextBlock.Effect>
                                                <media:DropShadowEffect Color="Black" BlurRadius="2" OffsetX="0" OffsetY="0" Opacity="1"/>
                                            </TextBlock.Effect>
                                        </TextBlock>
                                    </Grid>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    </StackPanel>
                </ScrollViewer>
                <StackPanel HorizontalAlignment="Right" VerticalAlignment="Bottom" Orientation="Horizontal" Spacing="8" Margin="16">
                    <Button Content="Статистика"
                            Command="{Binding ToggleStatsCommand}"
                            Padding="12,8"
                            ToolTip.Tip="Включить/выключить отображение статистики (поток, задержка, трафик) под камерами"/>
                    <Button Content="Сбросить зумы"
                            Command="{Binding ResetAllZoomsCommand}"
                            IsVisible="{Binding IsGroupSelected}"
                            Padding="12,8"/>
                </StackPanel>
            </Grid>
        </Grid>

        <!-- Нижняя панель с мониторингом -->
        <Border Grid.Row="2" Background="#1a1a1a" Padding="12,4" BorderBrush="#333" BorderThickness="0,1,0,0">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <TextBlock Grid.Column="0" Text="Система:" FontSize="11" Foreground="#666" VerticalAlignment="Center" Margin="0,0,12,0"/>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="16">
                    <!-- CPU -->
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="CPU:" FontSize="11" Foreground="#888" VerticalAlignment="Center"/>
                        <ProgressBar Value="{Binding CpuUsage}" 
                                     Minimum="0" Maximum="100" 
                                     Width="80" Height="12"
                                     VerticalAlignment="Center"
                                     Foreground="#4CAF50"/>
                        <TextBlock Text="{Binding CpuUsage, StringFormat='{}{0:F1}%'}" 
                                   FontSize="11" 
                                   Width="45"
                                   Foreground="#ccc" 
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    
                    <!-- RAM -->
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="RAM:" FontSize="11" Foreground="#888" VerticalAlignment="Center"/>
                        <ProgressBar Value="{Binding RamUsage}" 
                                     Minimum="0" Maximum="100" 
                                     Width="80" Height="12"
                                     VerticalAlignment="Center"
                                     Foreground="#2196F3"/>
                        <TextBlock Text="{Binding RamUsage, StringFormat='{}{0:F1}%'}" 
                                   FontSize="11" 
                                   Width="45"
                                   Foreground="#ccc" 
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    
                    <!-- GPU -->
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="GPU:" FontSize="11" Foreground="#888" VerticalAlignment="Center"/>
                        <ProgressBar Value="{Binding GpuUsage}" 
                                     Minimum="0" Maximum="100" 
                                     Width="80" Height="12"
                                     VerticalAlignment="Center"
                                     Foreground="#FF9800"/>
                        <TextBlock Text="{Binding GpuUsage, StringFormat='{}{0:F1}%'}" 
                                   FontSize="11" 
                                   Width="45"
                                   Foreground="#ccc" 
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
